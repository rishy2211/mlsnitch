name: mlsnitch

# Devnet stack:
# - ml-service: Python ML verification service (FastAPI + PyTorch stub)
# - chain:      Rust chain node (metrics on 9898)
# - api-gateway: Rust API + embedded consensus engine (API on 8081, metrics on 9898)
# - prometheus: Scrapes metrics from chain + api-gateway

services:
  ml-service:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.ml-service
    container_name: ml-service
    working_dir: /app/ml_service
    ports:
      - "8080:8080"
    environment:
      # Matches src/config.py and configs/ml-service.toml
      - ML_SERVICE_MODEL_ROOT=/app/ml_service/models
    volumes:
      - ml-models:/app/ml_service/models
      - ../configs/ml-service.toml:/app/config/ml-service.toml:ro
    networks:
      - devnet

  chain:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.chain
    container_name: chain
    working_dir: /app
    ports:
      # Prometheus metrics from the chain node.
      - "9898:9898"
    volumes:
      - chain-data:/app/data
    environment:
      - RUST_LOG=chain=info
      # Later, if you add config loading to the Rust code, you can point at devnet.toml:
      # - CHAIN_CONFIG=/app/configs/devnet.toml
    depends_on:
      - ml-service
    networks:
      - devnet

  api-gateway:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.api-gateway
    container_name: api-gateway
    working_dir: /app
    ports:
      # Public API.
      - "8081:8081"
      # Metrics for the API gateway (internally 9898, externally 9899 here).
      - "9899:9898"
    environment:
      - RUST_LOG=api_gateway=info,chain=info
      # Similarly, once config loading is implemented, you could inject:
      # - CHAIN_CONFIG=/app/configs/devnet.toml
    depends_on:
      - chain
      - ml-service
    networks:
      - devnet

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ../configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks:
      - devnet
    depends_on:
      - chain
      - api-gateway

volumes:
  chain-data:
  ml-models:

networks:
  devnet:
    driver: bridge
