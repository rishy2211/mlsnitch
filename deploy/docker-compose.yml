name: mlsnitch

services:
  chain:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.chain
    container_name: chain
    working_dir: /app
    ports:
      # Prometheus metrics from the chain node.
      - "9898:9898"
    volumes:
      - chain-data:/app/data
    environment:
      - RUST_LOG=chain=info
    networks:
      - devnet

  api-gateway:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.api-gateway
    container_name: api-gateway
    working_dir: /app
    ports:
      # Public API.
      - "8081:8081"
      # Metrics for the API gateway (internally 9898, externally 9899 here).
      - "9899:9898"
    environment:
      - RUST_LOG=api_gateway=info,chain=info
    networks:
      - devnet
    depends_on:
      - chain

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ../configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks:
      - devnet
    depends_on:
      - chain
      - api-gateway

volumes:
  chain-data:

networks:
  devnet:
    driver: bridge
