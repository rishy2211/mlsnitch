name: Python Code Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel older runs on same branch/PR
concurrency:
  group: python-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (black + ruff)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies (tools + project)
        run: |
          python -m pip install --upgrade pip
          # Install the project with dev extras (includes pytest, ruff, etc. if you keep them there)
          pip install -e ./ml_service[dev] || pip install -e ./ml_service
          # Ensure black + ruff are present even if not in extras
          pip install black ruff

      - name: Run black (check only)
        run: |
          black --check ml_service/src ml_service/tests || black --check ml_service/src

      - name: Run ruff
        run: |
          ruff check ml_service/src ml_service/tests || ruff check ml_service/src

  test:
    name: Tests (pytest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies (pytest + project)
        run: |
          python -m pip install --upgrade pip
          # Install the project with dev extras if available
          pip install -e ./ml_service[dev] || pip install -e ./ml_service
          # Ensure pytest is available even if not in extras
          pip install pytest

      - name: Run tests
        run: |
          if [ -d ml_service/tests ]; then
            pytest ml_service/tests
          else
            pytest
          fi
