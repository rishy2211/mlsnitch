name: Docker CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: docker-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-images:
    name: Build Docker images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target:
          - chain
          - api-gateway
          - ml-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.target }} image
        run: |
          case "${{ matrix.target }}" in
            chain)
              docker build \
                -f deploy/docker/Dockerfile.chain \
                -t chain-ci:latest \
                .
              ;;
            api-gateway)
              docker build \
                -f deploy/docker/Dockerfile.api-gateway \
                -t api-gateway-ci:latest \
                .
              ;;
            ml-service)
              docker build \
                -f deploy/docker/Dockerfile.ml-service \
                -t ml-service-ci:latest \
                .
              ;;
          esac
